/**
 * Synchronize.js
 * Version 1.2.2
 *
 *  Copyright (C) 2013-2015 Denis Meyer, calltopower88@googlemail.com
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU Lesser General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU Lesser General Public License for more details.
 *
 *  You should have received a copy of the GNU Lesser General Public License along
 *  with this program; if not, write to the Free Software Foundation, Inc.,
 *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
(function(e){function j(e){if(g&&window.console){console.log(e)}}function F(e,t,n){if(!isNaN(e)&&!isNaN(t)&&!isNaN(n)&&t<=n){return e>=t&&e<=n}else{return false}}function I(t){if(t){if(!R()){return e("#"+t)}else{return videojs(t)}}else{j("SJS: [getVideoObj] Undefined video element id '"+t+"'");return undefined}}function q(e){if(e){if(!R()){return I(e).get(0)}else{return videojs(e)}}else{j("SJS: [getVideo] Undefined video element id '"+e+"'");return undefined}}function R(){return!(typeof videojs==="undefined")}function U(e){if(R()&&e){var t=e.id();return t!=""?t:e}else{return e}}function z(e){if(!T){if(e){j("SJS: [play] Playing video element id '"+e+"'");q(e).play();return true}else{j("SJS: [play] Undefined video element id '"+e+"'");return false}}else{j("SJS: [play] A video is currently buffering");return false}}function W(e){if(e){j("SJS: [mute] Muting video element id '"+e+"'");if(!R()){q(e).muted=true}else{q(e).volume(0)}}else{j("SJS: [mute] Undefined video element id '"+e+"'");return undefined}}function X(e){if(e){j("SJS: [pause] Pausing video element id '"+e+"'");return q(e).pause()}else{j("SJS: [pause] Undefined video element id '"+e+"'");return false}}function V(e){if(e){if(!R()){return q(e).paused}else{return q(e).paused()}}else{j("SJS: [isPaused] Undefined video element id '"+e+"'");return false}}function $(e){if(e){if(!R()){return q(e).duration}else{return q(e).duration()}}else{j("SJS: [getDuration] Undefined video element id '"+e+"'");return-1}}function J(e){if(e){if(!R()){return q(e).currentTime}else{return q(e).currentTime()}}else{j("SJS: [getCurrentTime] Undefined video element id '"+e+"'");return-1}}function K(e,t){if(e){var n=$(e);if(n!=-1&&!isNaN(t)&&t>=0&&t<=n){if(!R()){q(e).currentTime=t}else{q(e).currentTime(t)}return true}else{j("SJS: [setCurrentTime] Could not set time for video element id '"+e+"'");K(e,n);return false}}else{j("SJS: [setCurrentTime] Undefined video element id '"+e+"'");return false}}function Q(e){if(e){if(!R()){return q(e).playbackRate}else{return q(e).playbackRate()}}else{j("SJS: [getPlaybackRate] Undefined video element id '"+e+"'");return 1}}function G(e,t){if(e){if(!R()){q(e).playbackRate=t}else{q(e).playbackRate(t)}return true}else{j("SJS: [setPlaybackRate] Undefined video element id '"+e+"'");return false}}function Y(e){if(e){if(!R()){return q(e).buffered}else{return q(e).buffered()}}else{j("SJS: [getBufferTimeRange] Undefined video element id '"+e+"'");return undefined}}function Z(e){var t=J(S);var n=J(e);if(t!=-1&&n!=-1&&!F(n,t-a,t)){return n-t}return 0}function et(){for(var t=0;t<y.length;++t){if(y[t]!=S){var n=false;var r=Z(y[t]);if(!B){if(r>d){if(Math.abs(r)<f){e(document).trigger("sjs:synchronizing",[J(S),y[t]]);j("SJS: [synchronize] Decreasing playback rate of video element id '"+y[t]+"' from "+Q(y[t])+" to "+(Q(S)-.5));G(y[t],Q(S)+c)}else{e(document).trigger("sjs:synchronizing",[J(S),y[t]]);G(y[t],Q(S));n=true}}else if(r<v){if(Math.abs(r)<f){e(document).trigger("sjs:synchronizing",[J(S),y[t]]);j("SJS: [synchronize] Increasing playback rate of video element id '"+y[t]+"' from "+Q(y[t])+" to "+(Q(S)-.5));G(y[t],Q(S)+l)}else{e(document).trigger("sjs:synchronizing",[J(S),y[t]]);G(y[t],Q(S));n=true}}else if(!V(S)&&!H[y[t]]){G(y[t],Q(S));j("SJS: [synchronize] Playing video element id '"+y[t]+"'");z(y[t])}}else if(B){if(Math.abs(r)>m&&Math.abs(r)>p){n=true}else if(!V(S)&&!H[y[t]]){j("SJS: [synchronize] Playing video element id '"+y[t]+"'");z(y[t])}}if(n){e(document).trigger("sjs:synchronizing",[J(S),y[t]]);j("SJS: [synchronize] Seeking video element id '"+y[t]+"': "+(J(S)+h));if(K(y[t],J(S)+h)){z(y[t]);if(!V(S)&&!H[y[t]]){j("SJS: [synchronize] Playing video element id '"+y[t]+"' after seeking");z(y[t])}else{j("SJS: [synchronize] Pausing video element id '"+y[t]+"' after seeking");X(y[t])}}}}}}function tt(e,t){j("SJS: [syncPause] Synchronizing. Pausing video id '"+e+"' for "+t/Q(S)+"s");H[e]=true;X(e);setTimeout(function(){H[e]=false;if(!V(S)){z(e);j("SJS: [syncPause] Synchronizing. Continuing to play video id '"+e+"' after "+t+"s")}else{j("SJS: [syncPause] Still pausing video id '"+e+"' after "+t+"s, as the master video is paused, too")}},t/Q(S)*1e3)}function nt(){if(ot()){var n=I(S);B=e("#"+S+"_flash_api").length!=0;n.on("play",function(){j("SJS: Master received 'play' event");e(document).trigger("sjs:masterPlay",[J(S)]);O=false;if(!C&&t){C=true;rt()}for(var n=0;n<y.length;++n){if(y[n]!=S){z(y[n]);W(y[n])}}});n.on("pause",function(){j("SJS: Master received 'pause' event");e(document).trigger("sjs:masterPause",[J(S)]);O=!A&&L;A=A?!A:A;for(var t=0;t<y.length;++t){if(y[t]!=S){X(y[t]);et()}}});n.on("ratechange",function(){j("SJS: Master received 'ratechange' event");e(document).trigger("sjs:masterPlaybackRateChanged",[Q(S)]);for(var t=0;t<y.length;++t){if(y[t]!=S){G(y[t],Q(S))}}});n.on("ended",function(){j("SJS: Master received 'ended' event");e(document).trigger("sjs:masterEnded",[$(S)]);O=true;for(var t=0;t<y.length;++t){if(y[t]!=S){et();X(y[t])}}});n.on("timeupdate",function(){e(document).trigger("sjs:masterTimeupdate",[J(S)]);O=true;var t=Date.now();if(t-o>u||V(S)){o=t;var n;var r;for(var i=0;i<y.length;++i){if(y[i]!=S){W(y[i]);r=V(y[i]);et()}}}})}else{for(var r=0;r<y.length;++r){X(y[r])}}}function rt(){k=window.setInterval(function(){var t=true;var n=J(S);for(var r=0;r<y.length;++r){var s=Y(y[r]);if(s){var o=$(y[r]);var u=J(y[r])+i;var a=false;for(var f=0;f<s.length&&!a;++f){u=u>=o?o:u;if(F(u,s.start(f),s.end(f))){a=true}}t=t&&a;T=!t}else{}}if(!t){L=true;A=true;for(var r=0;r<y.length;++r){X(y[r])}O=false;e(document).trigger("sjs:buffering",[])}else if(L&&!O){L=false;z(S);O=false;e(document).trigger("sjs:bufferedAndAutoplaying",[])}else if(L){L=false;e(document).trigger("sjs:bufferedButNotAutoplaying",[])}},n)}function it(t){E=t<y.length?t:0;S=y[E];e(document).trigger("sjs:masterSet",[S])}function st(e,t){if(e!=""){I(e).on("loadeddata",function(){D=true;if(t){t()}})}else{j("SJS: [doWhenDataLoaded] Undefined video element id '"+e+"'")}}function ot(){if(!R()){return x==y.length}else{for(var e=0;e<y.length;++e){if(!w[y[e]]){return false}}return true}}function ut(){if(!R()){return x==y.length}else{for(var e=0;e<y.length;++e){if(!b[y[e]]){return false}}return true}}function at(){var e=this;for(var t=0;t<y.length;++t){X(y[t])}N=true}function ft(){var e=this;for(var t=0;t<y.length;++t){X(y[t])}N=false}function lt(){if(M!=null){window.clearInterval(M);M=null}}var t=true;var n=1e3;var r=5e3;var i=2;var s=true;var o=0;var u=1e3;var a=1;var f=4;var l=.5;var c=-.5;var h=.25;var p=h+.05;var d=.05;var v=-.05;var m=.05;var g=false;var y=[];var b={};var w={};var E=0;var S;var x=0;var T=false;var N=false;var C=false;var k;var L=false;var A=false;var O=false;var M=null;var _=1e4;var D=false;var P=null;var H=[];var B=false;e.synchronizeVideos=function(t,n,i){var o=true;if(arguments.length==2){var u=e('video[mediagroup="'+n+'"]');for(var a=0;a<u.length;++a){var f=y.length;y[f]=u[a].getAttribute("id");var l="_html5_api";y[f]=R()&&y[f].indexOf(l)!=-1?y[f].substr(0,y[f].length-l.length):y[f];b[y[a-1]]=false;w[y[a-1]]=false}}else{E=t;for(var a=1;a<arguments.length;++a){o=o&&arguments[a]&&e("#"+arguments[a]).length;if(!o){e(document).trigger("sjs:invalidId",[arguments[a]])}else{y[y.length]=arguments[a];b[y[a-1]]=false;w[y[a-1]]=false}}}if(o&&y.length>1){if(!R()){for(var a=0;a<y.length;++a){e(document).trigger("sjs:idRegistered",[y[a]]);var c=t;I(y[a]).on("play",at);I(y[a]).on("pause",ft);I(y[a]).ready(function(){++x;if(ot()){it(c);for(var t=0;t<y.length;++t){I(y[t]).off("play",at);I(y[t]).off("pause",ft)}nt();if(N){z(S)}e(document).trigger("sjs:allPlayersReady",[])}})}}else{for(var a=0;a<y.length;++a){e(document).trigger("sjs:idRegistered",[y[a]]);var c=t;I(y[a]).on("play",at);I(y[a]).on("pause",ft);I(y[a]).ready(function(){var t=U(this);b[t]=true;st(t,function(){w[t]=true;e(document).trigger("sjs:playerLoaded",[t]);if(ot()){it(c);for(var n=0;n<y.length;++n){I(y[n]).off("play",at);I(y[n]).off("pause",ft)}nt();if(N){z(S)}e(document).trigger("sjs:allPlayersReady",[])}});P=window.setInterval(function(){if(!D){for(var e=0;e<y.length;++e){I(y[e]).trigger("loadeddata")}}else{window.clearInterval(P);P=null}},r)})}}}else{j("SJS: Not enough videos");e(document).trigger("sjs:notEnoughVideos",[])}if(s){e(document).on("sjs:buffering",function(e){j("SJS: Received 'sjs:buffering' event");M=setInterval(function(){if(ot()&&!O){z(S)}},_)});e(document).on("sjs:bufferedAndAutoplaying",function(e){j("SJS: Received 'sjs:bufferedAndAutoplaying' event");lt()});e(document).on("sjs:bufferedButNotAutoplaying",function(e){j("SJS: Received 'sjs:bufferedButNotAutoplaying' event");lt()})}e(document).on("sjs:play",function(e){j("SJS: Received 'sjs:play' event");if(ot()){z(S)}});e(document).on("sjs:pause",function(e){j("SJS: Received 'sjs:pause' event");if(ot()){X(S)}});e(document).on("sjs:setCurrentTime",function(e,t){j("SJS: Received 'sjs:setCurrentTime' event");if(ot()){K(S,t)}});e(document).on("sjs:synchronize",function(e){j("SJS: Received 'sjs:synchronize' event");if(ot()){et()}});e(document).on("sjs:startBufferChecker",function(e){j("SJS: Received 'sjs:startBufferChecker' event");if(!C){window.clearInterval(k);C=true;rt()}});e(document).on("sjs:stopBufferChecker",function(e){j("SJS: Received 'sjs:stopBufferChecker' event");window.clearInterval(k);C=false;T=false})};e(document).on("sjs:debug",function(e,t){g=t;j("SJS: Received 'sjs:debug' event")})})(jQuery)